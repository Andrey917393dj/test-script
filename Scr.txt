loadstring(game:HttpGetAsync("https://icebear.lol/StandUpright/LIB.txt"))()

local Workspace = game.Workspace

Start("Arctic")

CreateMenu("Quest Farm")
local QuestNPCNote = CreateNote("Selected Quest NPC: None", "Quest Farm")
local NPCNote = CreateNote("Selected NPC: None", "Quest Farm")

CreateButton("Tutorial", "Quest Farm", function()
    CreateNotification("Arctic", "Step 1 (Quest Selection), Stand Near Quest NPC And Press 'Select Quest NPC'", {})
    task.wait(5)
    CreateNotification("Arctic", "Step 2 (NPC Selection), Stand Near NPC To Kill And Press 'Select NPC'", {})
end)

local SelectedQuestNPC
local SelectedQuestNPCText = "None"
local SelectedNPC = "None"
local SelectedNPCName = "None"

CreateButton("Select Quest NPC", "Quest Farm", function()
    for i, v in pairs(Workspace.Map.NPCs:GetChildren()) do
        if v:FindFirstChild("HumanoidRootPart") then
            if (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude < 15 then
                local mainText = v.Head:FindFirstChild("Main") and v.Head.Main:FindFirstChild("Text")
                if mainText then
                    SelectedQuestNPCText = mainText.Text
                    SelectedQuestNPC = v
                    QuestNPCNote.Text = "Selected Quest NPC: " .. SelectedQuestNPCText
                    print("Selected Quest NPC: " .. SelectedQuestNPCText)  -- Debug print
                else
                    print("Main text not found for NPC: " .. v.Name)  -- Debug print
                end
                break
            end
        end
    end
end)

CreateButton("Select NPC", "Quest Farm", function()
    for i, v in pairs(Workspace.Living:GetChildren()) do
        if v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("AI") then
            if (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude < 15 then
                SelectedNPC = v.Name
                SelectedNPCName = v.Name
                NPCNote.Text = "Selected NPC: " .. SelectedNPCName
                print("Selected NPC: " .. SelectedNPCName)  -- Debug print
                break
            end
        end
    end
end)

local OnlyFarmNPC = false
CreateToggle("Only Farm NPC", "Quest Farm", function()
    OnlyFarmNPC = not OnlyFarmNPC
end)

local QuestDistance = 7
CreateNote("Farming Position", "Quest Farm")
CreateTextBox("Set Distance: ", "Quest Farm", {CustomText = "Default: 7"}, function(Input)
    QuestDistance = tonumber(Input) or 7
end)

local QUnderneath = false
CreateToggle("Underneath", "Quest Farm", function()
    QUnderneath = not QUnderneath
end)

local function TriggerQuest()
    if SelectedQuestNPC then
        local QuestDone = SelectedQuestNPC:FindFirstChild("QuestDone")
        local Done = SelectedQuestNPC:FindFirstChild("Done")
        
        if QuestDone then
            QuestDone:FireServer()
        else
            CreateNotification("Arctic", "Error Grabbing Remote 1", {})
        end
        
        if Done then
            Done:FireServer()
        else
            CreateNotification("Arctic", "Error Grabbing Remote 2", {})
        end
    else
        CreateNotification("Arctic", "Selected Quest NPC is not set.", {})
    end
end

local StartQuestFarming = false
CreateToggle("Begin Quest Farm", "Quest Farm", function()
    StartQuestFarming = not StartQuestFarming
    
    if StartQuestFarming then
        if (SelectedQuestNPC and SelectedNPC ~= "None") or (OnlyFarmNPC and SelectedNPC ~= "None") then
            while StartQuestFarming and task.wait() do
                pcall(function()
                    for i, v in pairs(Workspace.Living:GetChildren()) do
                        if v.Name == SelectedNPC and v.Humanoid.Health > 0 then
                            if not OnlyFarmNPC then
                                TriggerQuest()
                            end
                            repeat
                                task.wait()
                                
                                -- Ensure Stand is following the player
                                if game.Players.LocalPlayer.Character:FindFirstChild("Stand") and game.Players.LocalPlayer.Character:FindFirstChild("Stand"):FindFirstChild("HumanoidRootPart") then
                                    game.Players.LocalPlayer.Character.Stand:FindFirstChild("HumanoidRootPart").CFrame = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame
                                end

                                -- Move player to target NPC position
                                if QUnderneath then
                                    local npcCFrame = v.HumanoidRootPart.CFrame
                                    local newCFrame = CFrame.new(npcCFrame.Position - Vector3.new(0, QuestDistance, 0), npcCFrame.Position)
                                    game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = newCFrame
                                else
                                    game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = v.HumanoidRootPart.CFrame * CFrame.new(0, 0, QuestDistance)
                                end
                                game.Players.LocalPlayer.Character.HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)

                                -- Summon Stand if not already summoned
                                if game.Players.LocalPlayer.Character:FindFirstChild("Aura").Value == false then
                                    game.Players.LocalPlayer.Character.StandEvents.Summon:FireServer()
                                end

                                -- Attack the NPC
                                game:GetService("Players").LocalPlayer.Character.StandEvents.M1:FireServer()

                            until v.Humanoid.Health == 0 or not StartQuestFarming
                            
                            if not OnlyFarmNPC then
                                TriggerQuest()
                            end
                        end
                    end
                end)
            end
        else
            CreateNotification("Arctic", "You Are Missing A Step! Please Check Tutorial Then Re-Enable!")
        end
    end
end)

